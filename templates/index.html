<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дневник | Лицей 130</title>
    <script
    src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
    crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/static/css/fonts.css">
    <link rel="stylesheet" href="/static/css/index.css">
    <link rel="stylesheet" href="/static/css/inputs.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
  rel="stylesheet"
  href="https://unpkg.com/simplebar@latest/dist/simplebar.css"
/>
<script src="https://unpkg.com/simplebar@latest/dist/simplebar.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-md5@0.7.3/build/md5.min.js"></script>
</head>
<body>
    <div class="loadercont">
        <span class="loader"></span>
    </div>
    <div class="modalcont hide">
        <div class="modal">
            <a class="title">Смена пароля</a>
            <a class="error hide"></a>
            <form id="chng">
                <input type="password" placeholder="Старый пароль" id="old_val">
                <input type="password" placeholder="Новый пароль" id="new_val">
                <input type="submit" value="Изменить">
            </form>
        </div>
    </div>
    <div class="cont">
        <div class="maincont">
            <div class="headercont opened">
                <div class="header"><a class="usname">{{ ctx.fullname }}</a><a class="openmenu"><i class="fa-solid fa-angle-down"></i></a></div>
                <a class="lastupd">Обновлено {{ ctx.last_update }}</a>
                <div class="menu">
                    <a class="menuitem" onclick="openModal()"><i class="fa-solid fa-pen-to-square"></i> Изменить пароль</a>
                    <a class="menuitem" onclick="window.location.replace('/logout')"><i class="fa-solid fa-arrow-right-from-bracket"></i> Выйти</a>
                </div>
            </div>
            <div class="markscont">
                <div data-simplebar>
                    <table>
                        <tr>
                            <th>&nbsp;</th>
                            {% for date in ctx.dates %}
                            <th>{{ date }}</th>
                            {% endfor %}
                        </tr>
                        {% for lesson in ctx.lessons_names %}
                        <tr>
                            <th>{{ lesson }}</th>
                            {% for date in ctx.dates %}
                            <td>{{ ctx.marks[lesson][date] }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="by">by <a href="https://t.me/btless" target="_blank" rel="noopener noreferrer">@btless</a> & <a href="https://t.me/n1ret" target="_blank" rel="noopener noreferrer">@n1ret</a></div>
</body>
<script>
    function openModal(){
        $(".headercont").removeClass("opened");
        $('.modalcont').removeClass('hide')
    }
    document.body.onload=()=>{
        $(".menu").css("left",Math.max($(".header").width()-$(".menu").width()+5,0)+"px");
        
        $(".menu").get(0).style.setProperty("--menu-height", $(".menu").height()+"px");
        $(".headercont").removeClass("opened");
        
        $(".openmenu").click(()=>{
            $(".headercont").toggleClass("opened");
        });

        $(document.body).click((e)=>{
            if($(".headercont").hasClass("opened")){
                if(!["menuitem","openmenu"].includes(e.target.className)){
                    $(".headercont").removeClass("opened");
                }
            }
        });
        setTimeout(()=>{
            $(".loadercont").addClass("hide");
        },300);

        $(".modalcont").click((e)=>{
            if(e.target.className=="modalcont")
                $(".modalcont").addClass("hide");
        })

        function showError(err){
            $(".error").text(err);
            $(".error").removeClass("hide");
            $(".loadercont").addClass("hide");
        }
        $("#chng").submit(e=>{
            e.preventDefault();
            var req={
                user_id:{{ ctx.user_id }},
                old:md5($("#old_val").val()),
                new:md5($("#new_val").val())
            }
            console.log(req);
            setTimeout(()=>{
                fetch('/api/change_pass', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json;charset=utf-8'
                    },
                    body: JSON.stringify(req)
                }).then(response => {
                    $("#chng > input[type='submit']").prop("disabled",false);
                    if(response.ok){
                        response.json().then(result=>{
                            if(result.ok){
                                window.location.reload();
                            } else {
                                showError(result.error);
                            }
                        });
                    } else {
                        showError(response.statusText);
                    }
                });
            },500);
            $("#chng > input[type='submit']").prop("disabled",true);
            $(".loadercont").removeClass("hide");
            $(".error").addClass("hide");
        });
    }
</script>
</html>